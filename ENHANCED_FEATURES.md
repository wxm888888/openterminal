# å¢å¼ºç‰ˆè§£æå™¨åŠŸèƒ½è¯´æ˜

## ğŸ¯ è§£å†³çš„ä¸¤ä¸ªæ ¸å¿ƒé—®é¢˜

### é—®é¢˜1ï¼šç‰¹æ®Šæç¤ºç¬¦è¯†åˆ«ä¸å‡†ç¡®
**åŸå› ï¼š** ä¸åŒç”¨æˆ·çš„ç»ˆç«¯å¯èƒ½æœ‰å„ç§è‡ªå®šä¹‰æç¤ºç¬¦ï¼Œæ— æ³•é¢„å…ˆå®šä¹‰æ‰€æœ‰æ¨¡å¼

**è§£å†³æ–¹æ¡ˆï¼š** è‡ªé€‚åº”æç¤ºç¬¦å­¦ä¹ 

### é—®é¢˜2ï¼šè¯¯åˆ¤è½®æ¬¡
**åŸå› ï¼š** æŸäº›è¾“å‡ºè¡Œå¯èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼Œè¢«è¯¯è®¤ä¸ºæ˜¯æç¤ºç¬¦

**è§£å†³æ–¹æ¡ˆï¼š** LLMéªŒè¯è½®æ¬¡åˆ†å‰²

---

## ğŸš€ åŠŸèƒ½1ï¼šè‡ªé€‚åº”æç¤ºç¬¦å­¦ä¹ 

### å·¥ä½œæµç¨‹

```
[ç¬¬1æ­¥] å¿«é€Ÿæ‰«ææ–‡ä»¶ï¼ˆå‰100è¡Œï¼‰
   â†“
æ”¶é›†æ½œåœ¨çš„æç¤ºç¬¦è¡Œ
   - ä¸åŒ¹é…å·²çŸ¥æ¨¡å¼
   - çœ‹èµ·æ¥åƒæç¤ºç¬¦ï¼ˆæœ‰@ã€:ã€ç‰¹æ®Šç¬¦å·ç­‰ï¼‰
   - é‡å¤å‡ºç°çš„æ¨¡å¼
   â†“
[ç¬¬2æ­¥] å‘é€ç»™LLMåˆ¤æ–­
   â†“
"è¿™äº›è¡Œå“ªäº›æ˜¯çœŸæ­£çš„æç¤ºç¬¦ï¼Ÿ"
   â†“
[ç¬¬3æ­¥] LLMè¿”å›åˆ¤æ–­ç»“æœ
   â†“
{
  "prompts": [
    {
      "line": "example@host:~$",
      "is_prompt": true,
      "regex_pattern": "r'^example@host:[^$]+\\$'",
      "reason": "å…¸å‹çš„bashæç¤ºç¬¦æ ¼å¼"
    }
  ]
}
   â†“
[ç¬¬4æ­¥] å­¦ä¹ æ–°æ¨¡å¼
   â†“
å°†æ–°çš„æ­£åˆ™è¡¨è¾¾å¼æ·»åŠ åˆ° learned_patterns
   â†“
[ç¬¬5æ­¥] é‡æ–°è§£ææ–‡ä»¶
   â†“
ä½¿ç”¨æ›´æ–°åçš„æ¨¡å¼åº“
```

### ä»£ç å®ç°

```python
# 1. æ”¶é›†æ½œåœ¨æç¤ºç¬¦
def collect_potential_prompts(file_path):
    potential = []
    for line in lines[:100]:  # åªæ‰«æå‰100è¡Œ
        if not self.is_prompt_line(line):  # ä¸åŒ¹é…å·²çŸ¥æ¨¡å¼
            if self._looks_like_prompt(line):  # ä½†çœ‹èµ·æ¥åƒæç¤ºç¬¦
                potential.append(line)
    return potential

# 2. LLMåˆ¤æ–­
def learn_prompts_with_llm(potential_prompts):
    prompt = "è¯·åˆ¤æ–­è¿™äº›è¡Œæ˜¯å¦ä¸ºæç¤ºç¬¦ï¼Œå¹¶ç»™å‡ºæ­£åˆ™è¡¨è¾¾å¼"
    response = OpenAI.chat.completions.create(...)
    return new_patterns  # è¿”å›æ–°å­¦ä¹ åˆ°çš„æ¨¡å¼

# 3. ä½¿ç”¨æ–°æ¨¡å¼
self.learned_patterns.extend(new_patterns)
```

### å¯å‘å¼åˆ¤æ–­ï¼š`_looks_like_prompt()`

```python
def _looks_like_prompt(line):
    """è¿™è¡Œçœ‹èµ·æ¥åƒæç¤ºç¬¦å—ï¼Ÿ"""
    features = [
        '@' in line,                               # æœ‰@ç¬¦å·
        ':' in line,                               # æœ‰:ç¬¦å·
        line.endswith(('$', '#', '%', '>', 'â˜…')),  # ä»¥ç‰¹æ®Šç¬¦å·ç»“å°¾
        '(' in line and ')' in line,               # æœ‰æ‹¬å·
        len(line) < 200,                           # ä¸å¤ªé•¿
    ]
    return sum(features) >= 2  # è‡³å°‘æ»¡è¶³2ä¸ªç‰¹å¾
```

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯ï¼š** é‡åˆ°è‡ªå®šä¹‰æç¤ºç¬¦
```
[myenv] user@server ~/project (main) >>
```

**å¤„ç†è¿‡ç¨‹ï¼š**
```
1. ä¸åŒ¹é…å·²çŸ¥çš„4ä¸ªæ¨¡å¼
2. å¯å‘å¼åˆ¤æ–­ï¼šæœ‰@ã€:ã€æ‹¬å· â†’ å¯èƒ½æ˜¯æç¤ºç¬¦
3. åŠ å…¥ potential_prompts
4. å‘é€ç»™LLMï¼š"è¿™æ˜¯æç¤ºç¬¦å—ï¼Ÿ"
5. LLMå›å¤ï¼š
   {
     "is_prompt": true,
     "regex_pattern": "r'^\\[\\w+\\] [^@]+@[^ ]+ [^(]+ \\([^)]+\\) >>'"
   }
6. å­¦ä¹ æ–°æ¨¡å¼ï¼Œé‡æ–°è§£æ
```

---

## ğŸ” åŠŸèƒ½2ï¼šè½®æ¬¡éªŒè¯

### å·¥ä½œæµç¨‹

```
[ç¬¬1æ­¥] è§£æå®Œæˆï¼Œå¾—åˆ°æ‰€æœ‰è½®æ¬¡
   â†“
[ç¬¬2æ­¥] éå†æ¯ä¸ªè½®æ¬¡
   â†“
å–å‡º3ä¸ªè½®æ¬¡ï¼ˆå‰ä¸€ä¸ªã€å½“å‰ã€åä¸€ä¸ªï¼‰
   â†“
[ç¬¬3æ­¥] å‘é€ç»™LLMéªŒè¯
   â†“
"è¿™3ä¸ªè½®æ¬¡çš„åˆ†å‰²æ˜¯å¦æ­£ç¡®ï¼Ÿ"
   â†“
è½®æ¬¡ N-1: å‘½ä»¤A + è¾“å‡ºA
è½®æ¬¡ N:   å‘½ä»¤B + è¾“å‡ºB  â† [å…³æ³¨æ­¤è½®æ¬¡]
è½®æ¬¡ N+1: å‘½ä»¤C + è¾“å‡ºC
   â†“
[ç¬¬4æ­¥] LLMåˆ¤æ–­
   â†“
{
  "is_correct": false,
  "issue": "è½®æ¬¡Nçš„è¾“å‡ºå¯èƒ½åŒ…å«äº†è½®æ¬¡N+1çš„å‘½ä»¤",
  "suggestion": "åº”è¯¥åœ¨ç¬¬Xè¡Œåˆ†å‰²"
}
   â†“
[ç¬¬5æ­¥] è®°å½•é—®é¢˜
   â†“
ä¿å­˜éªŒè¯ç»“æœåˆ°è¾“å‡ºJSON
```

### ä»£ç å®ç°

```python
def verify_turns_with_llm(turns):
    results = []
    for i in range(len(turns)):
        # å–å‡ºä¸Šä¸‹æ–‡ï¼ˆ3ä¸ªè½®æ¬¡ï¼‰
        context = turns[max(0, i-1) : min(len(turns), i+2)]
        
        # å‘é€ç»™LLMéªŒè¯
        verification = self._verify_single_turn_group(context, focus_idx)
        
        results.append(verification)
        
        if not verification['is_correct']:
            print(f"âš ï¸  è½®æ¬¡ {turns[i]['turn_id']} å¯èƒ½æœ‰é—®é¢˜")
    
    return results
```

### LLMéªŒè¯æç¤ºè¯

```
ç³»ç»Ÿæç¤ºï¼š
ä½ æ˜¯ç»ˆç«¯äº¤äº’éªŒè¯ä¸“å®¶ã€‚åˆ¤æ–­è½®æ¬¡åˆ†å‰²æ˜¯å¦æ­£ç¡®ã€‚

åˆ¤æ–­æ ‡å‡†ï¼š
1. æ¯ä¸ªè½®æ¬¡åº”è¯¥åŒ…å«ï¼šå‘½ä»¤ + å¯¹åº”çš„è¾“å‡º
2. ä¸åº”è¯¥æŠŠä¸€ä¸ªå‘½ä»¤çš„è¾“å‡ºåˆ†åˆ°ä¸‹ä¸€ä¸ªè½®æ¬¡
3. ä¸åº”è¯¥æŠŠå¤šä¸ªå‘½ä»¤åˆå¹¶ä¸ºä¸€ä¸ªè½®æ¬¡

ç”¨æˆ·æ¶ˆæ¯ï¼š
è½®æ¬¡ 1:
  å‘½ä»¤: mkdir package
  è¾“å‡º: [æ—¶é—´æˆ³]
  åŸå§‹è¡Œæ•°: 3

è½®æ¬¡ 2: â† [å…³æ³¨æ­¤è½®æ¬¡]
  å‘½ä»¤: cd package/
  è¾“å‡º: [æ—¶é—´æˆ³]
  åŸå§‹è¡Œæ•°: 3

è½®æ¬¡ 3:
  å‘½ä»¤: touch __init__.py
  è¾“å‡º: [æ—¶é—´æˆ³]
  åŸå§‹è¡Œæ•°: 3

è¯·åˆ¤æ–­è½®æ¬¡2çš„åˆ†å‰²æ˜¯å¦æ­£ç¡®ã€‚
```

### ç¤ºä¾‹åœºæ™¯

**åœºæ™¯1ï¼šè¯¯åˆ¤ä¸ºä¸¤ä¸ªè½®æ¬¡**
```
åŸå§‹å†…å®¹ï¼š
user@host:~$ python script.py
Enter your name: John    â† è¿™è¡Œè¢«è¯¯åˆ¤ä¸ºæç¤ºç¬¦
Hello, John!

é”™è¯¯åˆ†å‰²ï¼š
è½®æ¬¡1: python script.py â†’ è¾“å‡º: Enter your name:
è½®æ¬¡2: John â†’ è¾“å‡º: Hello, John!

æ­£ç¡®åˆ†å‰²ï¼š
è½®æ¬¡1: python script.py â†’ è¾“å‡º: Enter your name: John\nHello, John!
```

**éªŒè¯è¿‡ç¨‹ï¼š**
```
LLMæ”¶åˆ°ï¼š
è½®æ¬¡1: å‘½ä»¤=python script.py, è¾“å‡º=Enter your name:
è½®æ¬¡2: å‘½ä»¤=John, è¾“å‡º=Hello, John!  â† å…³æ³¨

LLMåˆ¤æ–­ï¼š
{
  "is_correct": false,
  "issue": "è½®æ¬¡2çš„å‘½ä»¤'John'ä¸åƒshellå‘½ä»¤ï¼Œæ›´åƒæ˜¯ç”¨æˆ·è¾“å…¥",
  "suggestion": "åº”è¯¥åˆå¹¶åˆ°è½®æ¬¡1"
}
```

**åœºæ™¯2ï¼šä¸€ä¸ªå‘½ä»¤è¢«è¯¯åˆ¤ä¸ºå¤šä¸ªè½®æ¬¡**
```
åŸå§‹å†…å®¹ï¼š
user@host:~$ docker run -it ubuntu bash
root@container:/# ls
bin  boot  dev  etc

é”™è¯¯åˆ†å‰²ï¼š
è½®æ¬¡1: docker run -it ubuntu bash â†’ æ— è¾“å‡º
è½®æ¬¡2: ls â†’ è¾“å‡º: bin  boot  dev  etc

æ­£ç¡®ç†è§£ï¼š
è½®æ¬¡1: docker run -it ubuntu bash â†’ è¿›å…¥å®¹å™¨
è½®æ¬¡2: lsï¼ˆåœ¨å®¹å™¨å†…æ‰§è¡Œï¼‰ â†’ è¾“å‡º: bin  boot  dev  etc

è¿™ä¸ªæ˜¯æ­£ç¡®çš„ï¼ï¼ˆLLMä¼šåˆ¤æ–­ä¸ºæ­£ç¡®ï¼‰
```

---

## ğŸ“Š ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1ï¼šå®Œæ•´åŠŸèƒ½ï¼ˆæ¨èï¼‰

```python
from llm_enhanced import enhanced_parse_terminal_file

result = enhanced_parse_terminal_file(
    'data/raw/txt/7016.txt',
    'data/analyzed/7016_enhanced.json',
    enable_learning=True,       # å¯ç”¨è‡ªé€‚åº”å­¦ä¹ 
    enable_verification=True    # å¯ç”¨è½®æ¬¡éªŒè¯
)
```

**è¾“å‡ºï¼š**
```
======================================================================
å¢å¼ºç‰ˆç»ˆç«¯è§£æå™¨ - æ™ºèƒ½åˆ†ææ¨¡å¼
======================================================================

[é˜¶æ®µ1/3] è‡ªé€‚åº”æç¤ºç¬¦å­¦ä¹ 
  â†’ æœªå‘ç°éœ€è¦å­¦ä¹ çš„ç‰¹æ®Šæç¤ºç¬¦

[é˜¶æ®µ2/3] è§£ææ–‡ä»¶
  âœ“ å‘ç° 19 è½®äº¤äº’

[é˜¶æ®µ3/3] è½®æ¬¡éªŒè¯
[è½®æ¬¡éªŒè¯] å¼€å§‹éªŒè¯ 19 ä¸ªè½®æ¬¡çš„åˆ†å‰²å‡†ç¡®æ€§...
[è½®æ¬¡éªŒè¯] å®Œæˆï¼å‘ç° 0 ä¸ªæ½œåœ¨é—®é¢˜

âœ“ è§£æå®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ°: data/analyzed/7016_enhanced.json

======================================================================
è§£ææ‘˜è¦
======================================================================
æ€»è½®æ¬¡: 19
å­¦ä¹ åˆ°çš„æ–°æ¨¡å¼: 0
éªŒè¯ç»“æœ: 19/19 è½®æ¬¡æ­£ç¡®
```

### æ–¹å¼2ï¼šåªå¯ç”¨å­¦ä¹ 

```python
result = enhanced_parse_terminal_file(
    file_path,
    output_path,
    enable_learning=True,       # å¯ç”¨
    enable_verification=False   # ç¦ç”¨ï¼ˆèŠ‚çœAPIè°ƒç”¨ï¼‰
)
```

### æ–¹å¼3ï¼šåªå¯ç”¨éªŒè¯

```python
result = enhanced_parse_terminal_file(
    file_path,
    output_path,
    enable_learning=False,      # ç¦ç”¨
    enable_verification=True    # å¯ç”¨
)
```

### æ–¹å¼4ï¼šå‘½ä»¤è¡Œè¿è¡Œ

```bash
# å®Œæ•´åŠŸèƒ½
python3 scripts/llm_enhanced.py

# ä¼šè‡ªåŠ¨å¤„ç† data/raw/txt/7016.txt
# è¾“å‡ºåˆ° data/analyzed/7016_enhanced.json
```

---

## ğŸ“ è¾“å‡ºæ–‡ä»¶æ ¼å¼

```json
{
  "file_path": "data/raw/txt/7016.txt",
  "total_turns": 19,
  "initial_output": "...",
  "turns": [
    {
      "turn_id": 1,
      "action": {...},
      "observation": {...},
      "metadata": {...}
    },
    ...
  ],
  "learned_patterns": [
    "r'^\\[myenv\\] [^@]+@[^ ]+ .* >>'"
  ],
  "verification_results": [
    {
      "turn_id": 1,
      "is_correct": true,
      "issue": "",
      "suggestion": ""
    },
    {
      "turn_id": 2,
      "is_correct": false,
      "issue": "å‘½ä»¤çœ‹èµ·æ¥ä¸åƒshellå‘½ä»¤",
      "suggestion": "å¯èƒ½åº”è¯¥åˆå¹¶åˆ°ä¸Šä¸€è½®"
    },
    ...
  ]
}
```

---

## âš¡ æ€§èƒ½è€ƒè™‘

### APIè°ƒç”¨æ¬¡æ•°

**æ ‡å‡†æ¨¡å¼ï¼ˆllm.pyï¼‰ï¼š**
- åªåœ¨åˆ†æé˜¶æ®µè°ƒç”¨API
- è°ƒç”¨æ¬¡æ•° = è½®æ¬¡æ•°ï¼ˆå¦‚19è½® = 19æ¬¡ï¼‰

**å¢å¼ºæ¨¡å¼ï¼ˆllm_enhanced.pyï¼‰ï¼š**
- å­¦ä¹ é˜¶æ®µï¼š1æ¬¡ï¼ˆå¦‚æœæœ‰æ½œåœ¨æç¤ºç¬¦ï¼‰
- éªŒè¯é˜¶æ®µï¼šè½®æ¬¡æ•°æ¬¡ï¼ˆå¦‚19è½® = 19æ¬¡ï¼‰
- **æ€»è®¡ â‰ˆ è½®æ¬¡æ•° + 1**

### ä¼˜åŒ–å»ºè®®

1. **å°æ–‡ä»¶å…ˆéªŒè¯**
   - ç”¨å°æ–‡ä»¶æµ‹è¯•å­¦ä¹ å’ŒéªŒè¯æ•ˆæœ
   - ç¡®è®¤å‡†ç¡®åå†å¤„ç†å¤§æ–‡ä»¶

2. **æŒ‰éœ€å¯ç”¨åŠŸèƒ½**
   ```python
   # ç¬¬ä¸€æ¬¡è¿è¡Œï¼šå¯ç”¨å­¦ä¹ 
   result = enhanced_parse_terminal_file(
       file, output,
       enable_learning=True,
       enable_verification=False
   )
   
   # å¦‚æœå­¦ä¹ åˆ°æ–°æ¨¡å¼ï¼Œæ£€æŸ¥è§£æç»“æœ
   # å¦‚æœæœ‰ç–‘é—®ï¼Œå†å¯ç”¨éªŒè¯
   result = enhanced_parse_terminal_file(
       file, output,
       enable_learning=False,  # å·²å­¦ä¹ è¿‡
       enable_verification=True
   )
   ```

3. **æ‰¹é‡å¤„ç†ç­–ç•¥**
   ```python
   # å¯¹äºç›¸åŒæ ¼å¼çš„å¤šä¸ªæ–‡ä»¶
   # åªåœ¨ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸Šå­¦ä¹ 
   # å…¶ä»–æ–‡ä»¶å¤ç”¨å­¦åˆ°çš„æ¨¡å¼
   
   parser = EnhancedTerminalParser()
   
   # ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼šå­¦ä¹ 
   parser.learn_prompts_with_llm(...)
   
   # åç»­æ–‡ä»¶ï¼šç›´æ¥ä½¿ç”¨
   for file in files[1:]:
       result = parser.parse_file_line_by_line(file)
   ```

---

## ğŸ”§ è°ƒè¯•åŠŸèƒ½

### æŸ¥çœ‹å­¦ä¹ åˆ°çš„æ¨¡å¼

```python
parser = EnhancedTerminalParser()
potential = parser.collect_potential_prompts('file.txt')
print(f"å‘ç° {len(potential)} ä¸ªæ½œåœ¨æç¤ºç¬¦:")
for p in potential:
    print(f"  {p}")
```

### æŸ¥çœ‹éªŒè¯ç»“æœ

```python
result = enhanced_parse_terminal_file(...)

# åªçœ‹æœ‰é—®é¢˜çš„è½®æ¬¡
issues = [v for v in result['verification_results'] if not v['is_correct']]
for issue in issues:
    print(f"è½®æ¬¡ {issue['turn_id']}:")
    print(f"  é—®é¢˜: {issue['issue']}")
    print(f"  å»ºè®®: {issue['suggestion']}")
```

---

## ğŸ¯ æ€»ç»“

### åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | llm.pyï¼ˆåŸºç¡€ç‰ˆï¼‰ | llm_enhanced.pyï¼ˆå¢å¼ºç‰ˆï¼‰ |
|------|-----------------|-------------------------|
| åŸºç¡€è§£æ | âœ… | âœ… |
| è‡ªé€‚åº”å­¦ä¹  | âŒ | âœ… |
| è½®æ¬¡éªŒè¯ | âŒ | âœ… |
| APIè°ƒç”¨ | Næ¬¡ï¼ˆN=è½®æ¬¡æ•°ï¼‰ | N+1æ¬¡ï¼ˆå­¦ä¹ 1æ¬¡+éªŒè¯Næ¬¡ï¼‰ |
| å‡†ç¡®ç‡ | ä¾èµ–é¢„å®šä¹‰æ¨¡å¼ | è‡ªåŠ¨é€‚åº”+åŒé‡éªŒè¯ |

### æ¨èä½¿ç”¨åœºæ™¯

- **ä½¿ç”¨åŸºç¡€ç‰ˆï¼ˆllm.pyï¼‰ï¼š** æ ‡å‡†ç»ˆç«¯æ ¼å¼ï¼Œå·²çŸ¥æç¤ºç¬¦æ¨¡å¼
- **ä½¿ç”¨å¢å¼ºç‰ˆï¼ˆllm_enhanced.pyï¼‰ï¼š** 
  - è‡ªå®šä¹‰æç¤ºç¬¦
  - å¤æ‚ç»ˆç«¯æ ¼å¼
  - éœ€è¦é«˜å‡†ç¡®ç‡
  - ä¸ç¡®å®šåˆ†å‰²æ˜¯å¦æ­£ç¡®

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
# 1. è¿è¡Œå¢å¼ºç‰ˆ
cd /home/test/test1714/wxh/OpenTerminal
python3 scripts/llm_enhanced.py

# 2. æŸ¥çœ‹ç»“æœ
cat data/analyzed/7016_enhanced.json | python3 -m json.tool | less

# 3. æ£€æŸ¥éªŒè¯ç»“æœ
grep -A 5 '"is_correct": false' data/analyzed/7016_enhanced.json
```

æœ‰é—®é¢˜éšæ—¶å‘Šè¯‰æˆ‘ï¼
